@page "/users"
@using ChatApplication.Blazor.Models.User
@using ChatApplication.Blazor.Services.Interfaces
@using ChatApplication.Shared.Models
@using Microsoft.AspNetCore.WebUtilities

<PageTitle>Users</PageTitle>

@inject ISnackbar Snackbar;
@inject NavigationManager NavigationManager;
@inject IUserService UserService;

<MudPaper Elevation="3">
    <MudTable
        Items="@_userModels"
        Dense="@_dense"
        Hover="@_hover"
        @bind-SelectedItem="_userModel"
        SortLabel="Sort By"
        CommitEditTooltip="Commit Edit"
        OnCommitEditClick="@(() => Snackbar.Add("Commit Handle"))"
    >
        <ToolBarContent>
            <MudText Typo="Typo.h6">
                Users
            </MudText>
            <MudSpacer />
            <MudTextField
                Placeholder="Search"
                Adornment="Adornment.Start"
                AdornmentIcon="@Icons.Custom.Uncategorized.Baguette"
                IconSize="Size.Medium"
                Class="mt-0"
                Value="_searchString"
                ValueChanged="@( async (string searchString) => { await HandleSearchInput(searchString);})"
            >
            </MudTextField>
        </ToolBarContent>
        
        <ColGroup>
            <col style="width: 50px"/>
            <col style="width: 80px"/>
            <col style="width: 50%"/>
            <col/>
            <col/>
            <col style="width: 50px"/>
        </ColGroup>
        
        <HeaderContent>
            <MudTh>
                <MudTableSortLabel SortBy="new Func<UserModel, object>(c => c.Id)">
                    Id
                </MudTableSortLabel>
            </MudTh>
            <MudTh>
                <MudTableSortLabel SortBy="new Func<UserModel, object>(c => c.Email)">
                    Email
                </MudTableSortLabel>
            </MudTh>
            <MudTh>
                <MudTableSortLabel SortBy="new Func<UserModel, object>(c => c.UserName)">
                    User name
                </MudTableSortLabel>
            </MudTh>
        </HeaderContent>

        <RowTemplate>
            <MudTd>
                @context.Id
            </MudTd>
            <MudTd>
                @context.Email
            </MudTd>
            <MudTd>
                @context.UserName
            </MudTd>
        </RowTemplate>
        
        <RowEditingTemplate>
            <MudTd>
                @context.Id
            </MudTd>
            <MudTd>
                @context.Email
            </MudTd>
            <MudTd>
                @context.UserName
            </MudTd>
        </RowEditingTemplate>
        
        <PagerContent>
            <MudTablePager></MudTablePager>
        </PagerContent>
    </MudTable>
</MudPaper>

@code {
    private IEnumerable<UserModel> _userModels;
    private UserModel _userModel = new();
    private UserFilterModel _filterModel = new();
    private readonly bool _dense = false;
    private readonly bool _hover = true;
    private string _searchString = string.Empty;
    
    private async Task HandleSearchInput(string searchInput)
    {
        _searchString = searchInput;
        _filterModel.SearchString = _searchString;
        Navigate();
        _userModels = await UserService.GetUsersByFilterAsync(_filterModel);
    }
    
    private void Navigate()
    {
        var queryParams = new Dictionary<string, string>
        {
            ["page"] = !string.IsNullOrWhiteSpace(_filterModel.Page.ToString()) ? _filterModel.Page.ToString() : null,
            ["count"] = !string.IsNullOrWhiteSpace(_filterModel.Count.ToString()) ? _filterModel.Count.ToString() : null,
            ["searchString"] = !string.IsNullOrWhiteSpace(_filterModel.SearchString) ? _filterModel.SearchString : null
        };
        
        NavigationManager.NavigateTo(QueryHelpers.AddQueryString("chats", queryParams));
    }
    
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _filterModel.SearchString = _searchString;
            _userModels = await UserService.GetUsersByFilterAsync(_filterModel);

            StateHasChanged();
        }
    }

    protected override Task OnInitializedAsync()
    {
        var uri = NavigationManager.ToAbsoluteUri(NavigationManager.Uri);
        
        if (QueryHelpers.ParseQuery(uri.Query).TryGetValue("searchString", out var searchString))
        {
            _searchString = searchString;
        }
        
        if (QueryHelpers.ParseQuery(uri.Query).TryGetValue("page", out var page))
        {
            _filterModel.Page = int.Parse(page);
        }
        
        if (QueryHelpers.ParseQuery(uri.Query).TryGetValue("count", out var count))
        {
            _filterModel.Count = int.Parse(count);
        }
        
        
        return base.OnInitializedAsync();
    }
}